---
const pathname = Astro.url.pathname;
const links = [
  { href: "/", label: "About Me" },
  { href: "/research", label: "Research" },
  { href: "/publications", label: "Publications" },
  { href: "/cv", label: "CV" }
];
---

<nav class="site-nav" aria-label="Primary">
  <a class="brand" href="/">
    <img src="/logo.png" alt="Site logo" />
    <span class="brand-title">Zhiwei's Personal Website</span>
  </a>

  <ul class="desktop-links">
    {
      links.map((link) => {
        const isActive = pathname === link.href || (link.href !== "/" && pathname.startsWith(link.href));
        return (
          <li>
            <a href={link.href} aria-current={isActive ? "page" : undefined}>{link.label}</a>
          </li>
        );
      })
    }
  </ul>

  <details class="mobile-menu">
    <summary aria-label="Open menu"><span class="hamburger-icon" aria-hidden="true"></span></summary>
    <ul>
      {
        links.map((link) => {
          const isActive = pathname === link.href || (link.href !== "/" && pathname.startsWith(link.href));
          return (
            <li>
              <a href={link.href} aria-current={isActive ? "page" : undefined}>{link.label}</a>
            </li>
          );
        })
      }
    </ul>
  </details>
</nav>

<script is:inline>
  (() => {
    const init = () => {
      const menus = Array.from(document.querySelectorAll(".mobile-menu"));
      if (!menus.length) return;

      const closeMenu = (menu) => {
        menu.removeAttribute("open");
        const summary = menu.querySelector("summary");
        if (summary instanceof HTMLElement) summary.blur();
      };

      menus.forEach((menu) => {
        menu.querySelectorAll("a").forEach((link) => {
          link.addEventListener("click", () => closeMenu(menu));
        });
      });

      document.addEventListener("pointerdown", (event) => {
        menus.forEach((menu) => {
          if (!menu.contains(event.target)) closeMenu(menu);
        });
      });

      document.addEventListener("keydown", (event) => {
        if (event.key === "Escape") {
          menus.forEach((menu) => closeMenu(menu));
        }
      });
    };

    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", init);
    } else {
      init();
    }
  })();
</script>
